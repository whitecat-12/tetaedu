<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nayra AI Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
  body {
    margin: 0;
    background-color: #ffffff;
    color: #000000;
    font-family: 'Segoe UI', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ===== TOP BAR ===== */
  .top-bar {
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    background-color: #6f42c1; /* ungu */
    color: white;
    border-bottom: 1px solid #ccc;
  }

  .top-bar button {
    background-color: #ffffff;
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    color: #6f42c1;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }

  /* ===== SIDEBAR MENU ===== */
  .sidebar {
    height: 100%;
    width: 0;
    position: fixed;
    z-index: 100;
    top: 0;
    left: 0;
    background-color: #f8f0ff; /* ungu sangat muda */
    overflow-x: hidden;
    transition: 0.3s;
    padding-top: 60px;
  }

  .sidebar a {
    padding: 10px 20px;
    text-decoration: none;
    font-size: 18px;
    color: #6f42c1;
    display: block;
    transition: 0.2s;
  }

  .sidebar a:hover {
    background-color: #e5d4ff;
  }

  .sidebar .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 25px;
    cursor: pointer;
    color: #6f42c1;
  }

  /* ===== CHAT MAIN AREA ===== */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #ffffff;
  }

  #output {
    width: 100%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .bubble {
    padding: 10px 14px;
    border-radius: 16px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
  }

  .user {
    align-self: flex-end;
    background-color: #6f42c1;
    color: white;
  }

  .bot {
    align-self: flex-start;
    background-color: #f3e8ff; /* ungu muda */
    color: #000000;
  }

  /* ===== INPUT BAR ===== */
  .input-bar {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: #f8f0ff;
    border-top: 1px solid #ccc;
  }

  .input-container {
    display: flex;
    align-items: center;
    background-color: white;
    border-radius: 20px;
    flex: 1;
    padding: 8px 12px;
    margin-right: 10px;
    border: 1px solid #ccc;
  }

  .input-container i {
    margin-right: 8px;
    color: #6f42c1;
  }

  .input-container input {
    background: transparent;
    border: none;
    outline: none;
    color: black;
    flex: 1;
  }

  .send-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #6f42c1;
    cursor: pointer;
  }

  #micBtn {
    margin-left: 5px;
    font-size: 20px;
    transition: color 0.2s ease;
  }

  #micBtn.recording {
    color: red;
  }
</style>

</head>
<body>

  <!-- ===== SIDEBAR ===== -->
  <div id="mySidebar" class="sidebar">
  <span class="close-btn" onclick="closeSidebar()">&times;</span>
  
  <a href="../index2.html"><i class="fas fa-home"></i> Beranda</a>
  <a href="3davatar.html"><i class="fas fa-user"></i> 3D Avatar</a>
  </div>

  <!-- ===== TOP BAR ===== -->
  <div class="top-bar">
    <i class="fas fa-bars" onclick="openSidebar()"></i>
    <button><i class="fas fa-robot"></i> Nayra AI</button>
    <i class="fas fa-rotate-right" onclick="resetRiwayat()" title="Reset"></i>
  </div>

  <!-- ===== MAIN CHAT ===== -->
  <div class="main">
    <div id="output"></div>
  </div>

  <!-- ===== INPUT ===== -->
  <div class="input-bar">
    <div class="input-container">
      <i class="fas fa-plus"></i>
      <span style="margin-right: 10px; font-size: 14px;">Tools</span>
      <input type="text" id="input" placeholder="Tulis pesan..." onkeydown="if(event.key==='Enter') kirimTeks()" />
    </div>
    <button class="send-btn" onclick="kirimTeks()"><i class="fas fa-paper-plane"></i></button>
    <button class="send-btn" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
  </div>

  <!-- ===== SIDEBAR SCRIPT ===== -->
  <script>
    function openSidebar() {
      document.getElementById("mySidebar").style.width = "250px";
    }

    function closeSidebar() {
      document.getElementById("mySidebar").style.width = "0";
    }

  const GROQ_KEYS = [
    "Bearer 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",
    "Bearer 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"
  ];

  let history = ambilRiwayat();

  // --- Memori Chat ---
  function ambilRiwayat() {
    const data = localStorage.getItem("riwayatChat");
    return data ? JSON.parse(data) : [];
  }

  function simpanRiwayat() {
    localStorage.setItem("riwayatChat", JSON.stringify(history));
  }

  function resetRiwayat() {
    localStorage.removeItem("riwayatChat");
    history = [];
    document.getElementById("output").innerHTML = "";
  }

  // --- Memori Nama User ---
  function simpanNama(nama) {
    localStorage.setItem("namaUser", nama);
  }

  function ambilNama() {
    return localStorage.getItem("namaUser") || null;
  }

  // --- Format Markdown ---
  function formatMarkdownToHTML(md) {
    md = md.replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => {
      return `<pre><code class="language-${lang || ''}">${escapeHtml(code)}</code></pre>`;
    });
    md = md.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    md = md.replace(/\*(.*?)\*/g, '<em>$1</em>');
    return md.replace(/\n/g, "<br>");
  }

  function escapeHtml(str) {
    return str.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
  }

  // --- Coba API GROQ ---
  async function cobaGroqDenganBanyakKey(body) {
    for (const key of GROQ_KEYS) {
      try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": key,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) continue;
        return await res.json();
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }
    return { error: { message: "Mohon tunggu sebentar ya server kami penuh." } };
  }

  // --- Kirim Pesan ---
  async function kirimTeks() {
    const input = document.getElementById("input");
    const output = document.getElementById("output");
    const teks = input.value.trim();
    if (!teks) return;

    // Tampilkan chat user
    const userDiv = document.createElement("div");
    userDiv.className = "bubble user";
    userDiv.textContent = teks;
    output.appendChild(userDiv);

    history.push({ role: "user", content: teks });
    simpanRiwayat();
    input.value = "";

    // Loading
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "bubble bot";
    loadingDiv.textContent = "⏳ Sedang memproses...";
    output.appendChild(loadingDiv);
    output.scrollTop = output.scrollHeight;

    // Simpan nama user jika disebut
    const lowerTeks = teks.toLowerCase();
    if (lowerTeks.startsWith("nama saya") || lowerTeks.startsWith("namaku")) {
      const nama = teks.split(" ").pop();
      simpanNama(nama);
    }
    const namaUser = ambilNama();

    // Prompt sistem
    const systemPrompts = [
      "Kamu adalah Nayra AI dari teta education, asisten ramah pintar yang dikembangkan oleh teta edukation, jawaban wajib di jawab dengan bahasa Indonesia. Jawabanmu sopan, jelas, dan mudah dimengerti.",
      "Jika ada pertanyaan tentang LGBT atau perilaku yang dilarang agama, jelaskan bahwa semua agama utama (Islam, Kristen, Hindu, Buddha) melarang perilaku itu. Sampaikan dengan sopan, berikan saran positif untuk mendekatkan diri kepada Tuhan, mencari bimbingan agama, dan fokus pada kebaikan, jelaskan kamu nddak mendukung hal itu dan arahkan ke topik lain.",
      namaUser ? `Nama pengguna adalah ${namaUser}. Sapa dia dengan ramah.` : ""
    ];

    // Filter sensitif
    const sensitiveWords = ["lgbt", "gay", "lesbian", "homo", "biseks"];
    const isSensitive = sensitiveWords.some(word => lowerTeks.includes(word));

    const body = {
      model: "llama3-8b-8192",
      messages: [
        { role: "system", content: systemPrompts.join(" ") },
        ...history
      ],
      temperature: isSensitive ? 0.3 : 0.7
    };

    const data = await cobaGroqDenganBanyakKey(body);
    output.removeChild(loadingDiv);

    if (data.error) {
      const errorDiv = document.createElement("div");
      errorDiv.className = "bubble bot";
      errorDiv.textContent = "⚠️ Error: " + data.error.message;
      output.appendChild(errorDiv);
      return;
    }

    const reply = data.choices?.[0]?.message?.content || "Maaf, tidak ada jawaban.";
    history.push({ role: "assistant", content: reply });
    simpanRiwayat();

    // Tampilkan balasan bot
    const botDiv = document.createElement("div");
    botDiv.className = "bubble bot";
    botDiv.innerHTML = formatMarkdownToHTML(reply);
    output.appendChild(botDiv);
    hljs.highlightAll();

    bicara(reply);
    output.scrollTop = output.scrollHeight;
  }

  // --- Text to Speech ---
  function bicara(teks) {
    const ucap = new SpeechSynthesisUtterance(teks);
    ucap.lang = "id-ID";
    speechSynthesis.speak(ucap);
  }

  // --- Voice Recognition ---
  const recognition = window.SpeechRecognition || window.webkitSpeechRecognition
    ? new (window.SpeechRecognition || window.webkitSpeechRecognition)()
    : null;

  let isListening = false;

  if (recognition) {
    recognition.lang = "id-ID";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const teks = event.results[0][0].transcript;
      document.getElementById("input").value = teks;
      kirimTeks();
    };

    recognition.onerror = (event) => {
      alert("🎙️ Error saat merekam: " + event.error);
      isListening = false;
      updateMicBtn();
    };

    recognition.onend = () => {
      isListening = false;
      updateMicBtn();
    };
  }

  function toggleMic() {
    if (!recognition) {
      alert("Browser tidak mendukung pengenalan suara.");
      return;
    }

    if (isListening) {
      recognition.stop();
      isListening = false;
    } else {
      recognition.start();
      isListening = true;
    }

    updateMicBtn();
  }

  function updateMicBtn() {
    const micBtn = document.getElementById("micBtn");
    if (isListening) {
      micBtn.classList.add("recording");
      micBtn.innerHTML = '<i class="fas fa-stop"></i>';
    } else {
      micBtn.classList.remove("recording");
      micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    }
  }
</script>


</body>
</html>
